telegram_bot:
  - platform: polling
    api_key: !secret TELEGRAM_API_KEY
    allowed_chat_ids:
      - !secret TELEGRAM_CHAT_ID
notify:
  - name: telegram
    platform: telegram
    chat_id: !secret TELEGRAM_CHAT_ID

automation:
  - id: "telegram_bot_start"
    alias: "telegram_bot_start"
    description: ""
    triggers:
      - trigger: event
        event_type: telegram_command
        event_data:
          command: "/start"
    actions:
      - action: notify.telegram
        data:
          message: "ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:"
          data:
            inline_keyboard:
              - "ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ:/send_totals"
              - "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°:/set_totals"

  - id: "choose_meter"
    alias: "choose_meter"
    description: ""
    variables:
      toilet_hot_sn: "{{ states('sensor.water_toilet_hot_water_sn') | string }}"
      toilet_cold_sn: "{{ states('sensor.water_toilet_cold_water_sn') | string }}"
      bathroom_hot_sn: "{{ states('sensor.water_bathroom_hot_water_sn') | string }}"
      bathroom_cold_sn: "{{ states('sensor.water_bathroom_cold_water_sn') | string }}"
    triggers:
      - trigger: event
        event_type: telegram_callback
        event_data:
          command: "/set_totals"
    actions:
      - action: telegram_bot.delete_message
        data:
          chat_id: !secret TELEGRAM_CHAT_ID
          message_id: last
      - action: notify.telegram
        data:
          message: "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº:"
          message_tag: "menu"
          data:
            inline_keyboard:
              - "/{{ toilet_hot_sn }}, /{{ toilet_cold_sn }}"
              - "/{{ bathroom_hot_sn }}, /{{ bathroom_cold_sn }}"
              - "/T1, /T2"
              - "ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ:/cancel"
  - id: "telegram_bot_cancel"
    alias: "telegram_bot_cancel"
    description: ""
    triggers:
      - trigger: event
        event_type: telegram_callback
        event_data:
          command: "/cancel"
    actions:
      - action: telegram_bot.delete_message
        data:
          chat_id: !secret TELEGRAM_CHAT_ID
          message_id: last
      - action: notify.telegram
        data:
          message: "ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:"
          message_tag: "menu"
          data:
            inline_keyboard:
              - "ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ:/send_totals"
              - "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°:/set_totals"

  - id: "send_meters_totals"
    alias: send_meters_totals
    description: ""
    mode: single
    variables:
      toilet_hot_total: "{{ states('sensor.water_toilet_hot_water_total') | float | round(0)}}"
      toilet_cold_total: "{{ states('sensor.water_toilet_cold_water_total') | float | round(0) }}"
      toilet_hot_sn: "{{ states('sensor.water_toilet_hot_water_sn') | string }}"
      toilet_cold_sn: "{{ states('sensor.water_toilet_cold_water_sn') | string }}"

      bathroom_hot_total: "{{ states('sensor.water_bathroom_hot_water_total') | float | round(0) }}"
      bathroom_cold_total: "{{ states('sensor.water_bathroom_cold_water_total') | float | round(0) }}"
      bathroom_hot_sn: "{{ states('sensor.water_bathroom_hot_water_sn') | string }}"
      bathroom_cold_sn: "{{ states('sensor.water_bathroom_cold_water_sn') | string }}"

      energy_t1_total: "{{ states('sensor.energy_meter_total_t1') | float | round(0) }}"
      energy_t2_total: "{{ states('sensor.energy_meter_total_t2') | float | round(0) }}"
    triggers:
      - trigger: event
        event_type: telegram_callback
        event_data:
          command: "/send_totals"
      - trigger: template
        value_template: "{{ (now().day == 18) and (now().hour == 20) }}"
    actions:
      # - action: telegram_bot.answer_callback_query
      - action: notify.telegram
        data:
          # callback_query_id: "{{ trigger.event.data.id }}"
          title: "*ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸ĞºĞ¾Ğ²*"
          message: >
            _Ğ¥Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ°Ñ Ğ²Ğ¾Ğ´Ğ°:_
              `{{bathroom_cold_sn}}`: {{bathroom_cold_total}} mÂ³
              `{{toilet_cold_sn}}`: {{toilet_cold_total}} mÂ³
            _Ğ“Ğ¾Ñ€ÑÑ‡Ğ°Ñ Ğ²Ğ¾Ğ´Ğ°:_
              `{{bathroom_hot_sn}}`: {{bathroom_hot_total}} mÂ³
              `{{toilet_hot_sn}}`: {{toilet_hot_total}} mÂ³
            _Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ:_
              `T1`: {{energy_t1_total}} ĞºĞ’Ñ‚Â·Ñ‡
              `T2`: {{energy_t2_total}} ĞºĞ’Ñ‚Â·Ñ‡

  - id: "Door_to_open"
    alias: "Door is open"
    description: ""
    triggers:
      - trigger: state
        entity_id: binary_sensor.main_door
        to: "on"
    condition: []
    action:
      - action: notify.telegram
        data:
          message: "Ğ”Ğ²ĞµÑ€ÑŒğŸšª"
