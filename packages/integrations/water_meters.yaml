input_number:
  bathroom_set_hott_water:
    name: Bathroom_set_hot_water
    unit_of_measurement: "m3"
    mode: box
    initial: 100
    min: 0
    max: 1000000
    step: 0.001
    icon: mdi:water
  bathroom_set_cold_water:
    name: Bathroom_set_cold_water
    unit_of_measurement: "m3"
    mode: box
    initial: 100
    min: 0
    max: 1000000
    step: 0.001
    icon: mdi:water
  test_button:
    name: test_button
    unit_of_measurement: "℃"
    mode: box
    initial: 40
    min: 20
    max: 95
    step: 0.1

input_text:
  bathroom_hot_water_state:
    name: bathroom_hot_water_state
    initial: "unnown"

automation:
  - id: bathroom_hot_water_state_message
    alias: bathroom_hot_water_state_message
    description: ""
    variables:
      upper_treshold: 50
      lower_treshold: 40
      temperature: "{{ states('sensor.water_bathroom_hot_water_temperature') | float }}"
    mode: single
    triggers:
      - trigger: state
        entity_id:
          - sensor.water_bathroom_hot_water_temperature
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: >
                  {{ temperature > upper_treshold }}
              - condition: template
                value_template: >
                  {{ states('input_text.bathroom_hot_water_state') != "normal" }}
            sequence:
              - action: input_text.set_value
                target:
                  entity_id: input_text.bathroom_hot_water_state
                data:
                  value: "normal"
              - service: telegram_bot.send_message
                data:
                  message: >
                    Температура воды в ванной в норме: {{ temperature }}°C
          - conditions:
              - condition: template
                value_template: >
                  {{ temperature < lower_treshold }}
              - condition: template
                value_template: >
                  {{ states('input_text.bathroom_hot_water_state') != "cold" }}
            sequence:
              - action: input_text.set_value
                target:
                  entity_id: input_text.bathroom_hot_water_state
                data:
                  value: "cold"
              - service: telegram_bot.send_message
                data:
                  message: >
                    Температура воды в ванной меньше {{ lower_treshold }}°C

  - id: "bathroom_set_hot_water"
    alias: bathroom_set_hot_water
    description: ""
    mode: single
    variables:
      new_consumption: "{{ states('input_number.bathroom_set_hot_water') | float }}"
    triggers:
      - trigger: state
        entity_id:
          - input_number.bathroom_set_hot_water
    action:
      - service: esphome.water_bathroom_set_total_hot_water_consumption
        data:
          value: "{{ new_consumption }}"
      - service: telegram_bot.send_message
        data:
          message: >
            Установлены показания счетчика горячей воды в ванной: {{ new_consumption }}m3

  - id: "bathroom_set_cold_water"
    alias: bathroom_set_cold_water
    description: ""
    mode: single
    variables:
      new_consumption: "{{ states('input_number.bathroom_set_cold_water') | float }}"
    triggers:
      - trigger: state
        entity_id:
          - input_number.bathroom_set_cold_water
    action:
      - service: esphome.water_bathroom_set_total_cold_water_consumption
        data:
          value: "{{ new_consumption }}"
      - service: telegram_bot.send_message
        data:
          message: >
            Установлены показания счетчика холодной воды в ванной: {{ new_consumption }}m3
